<html>
<!$Id: manual.html,v 1.6 2003/05/02 10:51:33 tomas Exp $>

<head>
<style type="text/css">
ul { list-style-type: disc };
</style>
</head>

<body bgcolor="#FFFFFF">

<hr>

<center>
<table border=0 cellspacing=2 cellpadding=2>
<tr><td align=center><a href="http://www.lua.org">
<img border=0 alt="The Lua language" src="lua.png"></a>
<tr><td align=center><big><b>LuaSQL Reference Manual</b></big>
<tr><td align=center valign=top>Database connectivity for the Lua language
</table>
</center>
<p>

<center><small>
<a href="index.html#over">overview</a> &middot;
<a href="index.html#version">current version</a> &middot;
<a href="index.html#new">what's new</a> &middot;
<a href="index.html#down">download</a> &middot;
<a href="index.html#hist">history</a>
</small></center>
<p>

<hr>

<a name="overview"></a>
<h2>Overview</h2>
<p>
LuaSQL is a simple interface from Lua to a DBMS.
It has a collection of drivers to some popular databases
(actually PostgreSQL and ODBC, Oracle, MySQL and ADO will be
ready soon).
LuaSQL defines a simple object oriented API that must be
implemented by all drivers but each one can offer other
specific features.
<p>
LuaSQL defines one single global variable,
a table called <tt>luasql</tt>.
This table is used to store the initialization methods of the
loaded drivers.
This method is used to create an
<a href="#environment_class">Environment object</a>
which is used to create a
<a href="#connection_class">Connection object</a>.
A connection object can execute SQL statements and eventually
create a
<a href="#cursor_class">Cursor object</a>
which is used to retrieve data.
<p>
Each LuaSQL driver is composed by two files:
a C source file that implements the driver functions;
and a Lua script used to load the dynamic library.
The host application can be statically linked with one or more drivers
or they can be loaded dynamically by the corresponding Lua script (this
requires the built-in <tt>loadlib</tt> function Lua 5 offers).
</p>


<a name="environment_class">
<h2>Environment class</h2>
<p>
An Environment object is created by calling the method with the
same name of the driver (odbc, postgres etc.).
For example, <tt>luasql.odbc()</tt>, will try to create an environment
object using the ODBC driver.
</p>

<h4>Methods</h4>

<ul>
<a name="env_close"></a>
<li> <tt>close()</tt> <br>
Closes this environment. Only successful if all connections pertaining to
it were closed first.

<a name="env_connect"></a>
<li> <tt>connect(sourcename[,username[,password]])</tt> <br>
Connects to a data source specified in <tt>sourcename</tt> using 
<tt>username</tt> and <tt>password</tt> if they are supplied.<br>
See also: <a href="#postgres_extensions">PostgreSQL extensions</a><br>
Returns: a <a href="connection_class">Connection object</a>.

</ul>

<a name="connection_class">
<h2>Connection class</h2>

A Connection object contains specific attributes and parameters of a single
data source connection.
A Connection object is created by calling the
<tt><a href="#env_connect">environment:connect</a></tt>
method.

<h4>Methods</h4>

<ul>
<a name="conn_close"></a>
<li> <tt>close()</tt> <br>
Closes this connection.
Only successful if all cursors pertaining to it were closed first.

<a name="conn_commit"></a>
<li> <tt>commit()</tt> <br>
Commits the current transaction.

<a name="conn_execute"></a>
<li> <tt>execute(statement)</tt> <br>
Executes the given SQL <tt>statement</tt>.<br>
Returns: a <a href="cursor_class">Cursor object</a>
if there are results, or the number of rows affected by the command otherwise.

<a name="conn_rollback"></a>
<li> <tt>rollback()</tt> <br>
Rolls back the current transaction.

<a name="conn_setautocommit"></a>
<li> <tt>setautocommit(boolean)</tt> <br>
Turns on or off the "auto commit" mode.
This feature might not work on database systems that don't implement
transactions.
Turning off the "auto commit" mode should begin a new transaction;
turning the mode on will roll back the current transaction.

<!--
<li> <tt>TableList()</tt> <br>==&gt; So' no ODBC &lt;==
Retrieves a list of all the tables in the data source. <br>
Returns: a list of the table names.
</p>
-->

</ul>


<a name="cursor_class"></a>
<h2>Cursor class</h2>

A Cursor object contains methods permitting the retrieval of 
data resulting from an executed statement.
A Cursor object is created by using the
<tt><a href="#conn_execute">Connection:execute</a></tt>
function.
See also <a href="#postgres_extensions">PostgreSQL extensions</a>.

<h4>Methods</h4>

<ul>
<a name="cur_close"></a>
<li> <tt>close()</tt> <br>
Closes this cursor. 

<a name="cur_fetch"></a>
<li> <tt>fetch([table[,modestring]])</tt> <br>
Retrieves the next row of results.<br>
If <tt>fetch</tt> is called without parameters,
the results will be returned to the caller directly.
If <tt>fetch</tt> is called with a table, the results will be copied
to the table and this table will be returned (for convenience).
In this case, an optional <tt>mode</tt> parameter can be used.
It is just a string indicating how the result table should be made.
The mode string can contain:
<ul>
  <li> <b>"n"</b> the resulting table will have numerical indices
  <li> <b>"a"</b> the resulting table will have alphanumerical indices
</ul>
The optional <tt>table</tt> parameter is a table that should be
used to store the next row.
This should improve the performance when retrieving many rows with many fields.<br>
Returns: data, as above, or <tt>nil</tt> if there aren't any rows left
followed by an error message if any.

<a name="cur_colnames"></a>
<li> <tt>getcolnames()</tt> <br>
Returns: a table with the list of column names.

<a name="cur_coltypes"></a>
<li> <tt>getcoltypes()</tt> <br>
Returns: a table with the list of column types.

</ul>


<a name="postgres_extensions"></a>
<h2>PostgreSQL extensions</h2>

Besides the basic functionality
provided by all drivers (see manual), the Postgres driver also offers
these extra features:

<ul>
  <li><tt>environment:connect(sourcename[,username[,password[,hostname[,port]]]])</tt><br>
    In PostgreSQL driver, this method has two other optional parameters
    that indicate the hostname and port to connect.
    Also, the first parameter can contain all connection information,
    as stated in the documentation for <tt>PQconnectdb</tt> function
    in the PostgreSQL manual
    (e.g. <small><tt>environment:connect("dbname=&lt;<i>name</i>&gt; user=&lt;<i>username</i>&gt;")</tt></small>)
  <li><tt>cursor:numrows()</tt><br>
    This additional method returns the number of rows in the query result.
</ul>


<a name="examples"></a>
<h2>Examples</h2>

Below is a small sample code displaying the basic use of the library.

<blockquote>
<pre>
-- load driver
require"postgres"
-- create environment object
env, err = luasql.postgres()
assert(env, err)
-- connect to data source
con, err = env:connect("luasql-test")
assert(con, err)
-- reset our table
res, err = con:execute"DROP TABLE people"
res, err = con:execute[[
  CREATE TABLE people(
    name  varchar(50),
    email varchar(50)
  )
]]
assert(res, err)
-- add a few elements
list = {
    { name="Tomas Guisasola", email="tomas@kepler.org", },
    { name="Roberto Ierusalimschy", email="roberto@kepler.org", },
    { name="Andre Carregal", email="carregal@kepler.org", },
}
for i, p in pairs (list) do
  res, err = con:execute(string.format([[
    INSERT INTO people
    VALUES ('%s', '%s')]], p.name, p.email)
  )
  assert(res, err)
end
-- retrieve a cursor
cur, err = con:execute"SELECT name, email from people"
assert(cur, err)
-- print all rows
row = cur:fetch ({}, "a")	-- the rows will be indexed by field names
while row do
	print(string.format("Name: %s, E-mail: %s", row.name, row.email))
	row = cur:fetch (row, "a")	-- reusing the table of results
end
-- close everything
cur:close()
con:close()
env:close()
</pre>
</blockquote>

And the output of this script should be:

<blockquote>
<pre>
Name: Tomas Guisasola, E-mail: tomas@kepler.org
Name: Roberto Ierusalimschy, E-mail: roberto@kepler.org
Name: Andre Carregal, E-mail: carregal@kepler.org
</pre>
</blockquote>


<a name="contents"></a>
<h2>Contents</h2>
<p>
<ul>
<li> <a href="#overview">Overview</a>
<li> <a href="#environment_class">Environment class</a>
  <ul>
    <li> <a href="#env_close">close</a>
    <li> <a href="#env_connect">connect</a>
  </ul>
<li> <a href="#connection_class">Connection class</a>
  <ul>
    <li> <a href="#conn_close">close</a>
    <li> <a href="#conn_commit">commit</a>
    <li> <a href="#conn_execute">execute</a>
    <li> <a href="#conn_rollback">rollback</a>
    <li> <a href="#conn_setautocommit">setautocommit</a>
  </ul>
<li> <a href="#cursor">Cursor class</a>
  <ul>
    <li> <a href="#cur_close">close</a>
    <li> <a href="#cur_fetch">fetch</a>
    <li> <a href="#cur_colnames">getcolnames</a>
    <li> <a href="#cur_coltypes">getcoltypes</a>
  </ul>
<li> <a href="postgres_extensions">PostgreSQL extensions</a>
<li> <a href="#examples">Examples</a>
</ul>
</p>


<p>
<center>
<a href=#over>overview</a> &middot;
<a href=#current>current version</a> &middot;
<a href=#new>what's new</a> &middot;
<a href=#down>download</a> &middot;
<a href=#manual>manual</a> &middot;
<a href=#hist>history</a>
</center>
<p>

<hr>
<small>
Last modified by Tom&aacute;s Guisasola on<br>
Fri May  2 10:50:37 BRT 2003
</small>

</body>
</html> 
